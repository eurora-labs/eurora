name: 'Publish Chrome Extension'
env:
    RUSTUP_TOOLCHAIN: stable
permissions:
    contents: read # Required for checkout
    actions: read # Required for downloading artifacts
on:
    workflow_dispatch:
        inputs:
            channel:
                type: choice
                required: true
                description: channel
                default: nightly
                options:
                    - release
                    - nightly
            bump:
                type: choice
                required: true
                description: update type
                default: patch
                options:
                    - undefined
                    - patch
                    - minor
                    - major

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-chrome:
        runs-on: ubuntu-latest
        environment:
            name: chrome-addons

        outputs:
            version: ${{ env.version }}
            channel: ${{ env.channel }}

        steps:
            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Consume input variables
              shell: bash
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  echo "channel=$INPUT_CHANNEL" >> $GITHUB_ENV
                  echo "bump=$INPUT_BUMP" >> $GITHUB_ENV

            - name: Calculate next version
              shell: bash
              env:
                  CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  # Fetch current version from API
                  # CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/extensions/${CHANNEL}" | jq -r '.browsers.chrome.version // "0.5.0"')"
                  CURRENT_VERSION="0.5.0"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP}")
                  echo "version=$NEXT_VERSION" >> $GITHUB_ENV
                  mkdir -p release && echo "$NEXT_VERSION" > release/version
                  echo "Chrome extension version: $NEXT_VERSION (previous: $CURRENT_VERSION)"

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - name: Build Chrome extension
              run: pnpm run build:chrome
              env:
                  NODE_ENV: production
                  VERSION: ${{ env.version }}

            - name: Create Chrome extension zip
              shell: bash
              run: |
                  cd apps/browser/dist/chrome
                  zip -r ../../../../release/chrome-extension.zip . -x "*.git*" -x "*.zip"
                  cd ../../../..
                  echo "Created release/chrome-extension.zip"
                  ls -lh release/chrome-extension.zip

            - name: Upload Artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: '${{ env.channel }}-chrome-${{ github.run_number }}'
                  path: release/
                  if-no-files-found: error

    publish-chrome:
        needs: [build-chrome]
        runs-on: ubuntu-latest
        environment:
            name: chrome-addons
        permissions:
            contents: write # Required for creating and pushing git tags

        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Download artifacts
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: '${{ needs.build-chrome.outputs.channel }}-chrome-${{ github.run_number }}'
                  path: release

            - name: Extract version
              shell: bash
              run: |
                  VERSION="$(cat release/version)"
                  echo "version=$VERSION" >> $GITHUB_ENV

            - name: Upload to Chrome Web Store (Release)
              if: needs.build-chrome.outputs.channel == 'release'
              shell: bash
              env:
                  CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
                  CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
                  CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
                  CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
              run: |
                  # Get access token using refresh token
                  TOKEN_RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
                    -H "Content-Type: application/x-www-form-urlencoded" \
                    --data-urlencode "client_id=$CHROME_CLIENT_ID" \
                    --data-urlencode "client_secret=$CHROME_CLIENT_SECRET" \
                    --data-urlencode "refresh_token=$CHROME_REFRESH_TOKEN" \
                    --data-urlencode "grant_type=refresh_token")

                  ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')

                  if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
                    echo "Failed to get access token"
                    echo "Token response: $TOKEN_RESPONSE"
                    echo "Error: $(echo "$TOKEN_RESPONSE" | jq -r '.error // empty')"
                    echo "Error description: $(echo "$TOKEN_RESPONSE" | jq -r '.error_description // empty')"
                    exit 1
                  fi

                  # Upload the extension
                  UPLOAD_RESPONSE=$(curl -s -X PUT \
                    "https://www.googleapis.com/upload/chromewebstore/v1.1/items/$CHROME_EXTENSION_ID" \
                    -H "Authorization: Bearer $ACCESS_TOKEN" \
                    -H "x-goog-api-version: 2" \
                    -F "file=@release/chrome-extension.zip")

                  echo "Upload response: $UPLOAD_RESPONSE"

                  UPLOAD_STATUS=$(echo "$UPLOAD_RESPONSE" | jq -r '.uploadState')
                  if [ "$UPLOAD_STATUS" != "SUCCESS" ]; then
                    echo "Upload failed with status: $UPLOAD_STATUS"
                    echo "$UPLOAD_RESPONSE" | jq -r '.itemError[]?.error_detail // empty'
                    exit 1
                  fi

                  echo "Extension uploaded successfully"

                  # Publish the extension
                  PUBLISH_RESPONSE=$(curl -s -X POST \
                    "https://www.googleapis.com/chromewebstore/v1.1/items/$CHROME_EXTENSION_ID/publish" \
                    -H "Authorization: Bearer $ACCESS_TOKEN" \
                    -H "x-goog-api-version: 2" \
                    -H "Content-Length: 0")

                  echo "Publish response: $PUBLISH_RESPONSE"

                  PUBLISH_STATUS=$(echo "$PUBLISH_RESPONSE" | jq -r '.status[0]')
                  if [ "$PUBLISH_STATUS" != "OK" ] && [ "$PUBLISH_STATUS" != "PENDING_REVIEW" ]; then
                    echo "Publish failed with status: $PUBLISH_STATUS"
                    exit 1
                  fi

                  echo "Extension published successfully (status: $PUBLISH_STATUS)"

            - name: Upload to Chrome Web Store (Nightly/Trusted Testers)
              if: needs.build-chrome.outputs.channel == 'nightly'
              shell: bash
              env:
                  CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
                  CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
                  CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
                  CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
              run: |
                  # Get access token using refresh token
                  TOKEN_RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
                    -H "Content-Type: application/x-www-form-urlencoded" \
                    --data-urlencode "client_id=$CHROME_CLIENT_ID" \
                    --data-urlencode "client_secret=$CHROME_CLIENT_SECRET" \
                    --data-urlencode "refresh_token=$CHROME_REFRESH_TOKEN" \
                    --data-urlencode "grant_type=refresh_token")

                  ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')

                  if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
                    echo "Failed to get access token"
                    echo "Token response: $TOKEN_RESPONSE"
                    echo "Error: $(echo "$TOKEN_RESPONSE" | jq -r '.error // empty')"
                    echo "Error description: $(echo "$TOKEN_RESPONSE" | jq -r '.error_description // empty')"
                    exit 1
                  fi

                  # Upload the extension
                  UPLOAD_RESPONSE=$(curl -s -X PUT \
                    "https://www.googleapis.com/upload/chromewebstore/v1.1/items/$CHROME_EXTENSION_ID" \
                    -H "Authorization: Bearer $ACCESS_TOKEN" \
                    -H "x-goog-api-version: 2" \
                    -F "file=@release/chrome-extension.zip")

                  echo "Upload response: $UPLOAD_RESPONSE"

                  UPLOAD_STATUS=$(echo "$UPLOAD_RESPONSE" | jq -r '.uploadState')
                  if [ "$UPLOAD_STATUS" != "SUCCESS" ]; then
                    echo "Upload failed with status: $UPLOAD_STATUS"
                    echo "$UPLOAD_RESPONSE" | jq -r '.itemError[]?.error_detail // empty'
                    exit 1
                  fi

                  echo "Extension uploaded successfully"

                  # Publish to trusted testers only
                  PUBLISH_RESPONSE=$(curl -s -X POST \
                    "https://www.googleapis.com/chromewebstore/v1.1/items/$CHROME_EXTENSION_ID/publish?publishTarget=trustedTesters" \
                    -H "Authorization: Bearer $ACCESS_TOKEN" \
                    -H "x-goog-api-version: 2" \
                    -H "Content-Length: 0")

                  echo "Publish response: $PUBLISH_RESPONSE"

                  PUBLISH_STATUS=$(echo "$PUBLISH_RESPONSE" | jq -r '.status[0]')
                  if [ "$PUBLISH_STATUS" != "OK" ] && [ "$PUBLISH_STATUS" != "PENDING_REVIEW" ]; then
                    echo "Publish failed with status: $PUBLISH_STATUS"
                    exit 1
                  fi

                  echo "Extension published to trusted testers (status: $PUBLISH_STATUS)"

            - name: Prepare S3 payload
              shell: bash
              run: |
                  rm -rf release-s3
                  mkdir -p release-s3
                  cp release/chrome-extension.zip release-s3/

            - uses: shallwefootball/s3-upload-action@0d261a6f15b3b2e209dfebdecace4b100c04f95b # master
              name: Upload To S3
              id: S3
              with:
                  aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws_bucket: 'releases.eurora-labs.com'
                  source_dir: 'release-s3/'
                  destination_dir: 'extensions/${{ needs.build-chrome.outputs.channel }}/chrome/${{ env.version }}-${{ github.run_number }}'

    create-git-tag:
        needs: [publish-chrome, build-chrome]
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required for creating and pushing git tags
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Download artifacts
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: '${{ needs.build-chrome.outputs.channel }}-chrome-${{ github.run_number }}'
                  path: release

            - name: Extract version
              shell: bash
              run: |
                  VERSION="$(cat release/version)"
                  echo "version=$VERSION" >> $GITHUB_ENV

            - name: Create git tag
              shell: bash
              env:
                  OUTPUT_CHANNEL: ${{ needs.build-chrome.outputs.channel }}
                  VERSION: ${{ env.version }}
              run: |
                  TAG_NAME="chrome/${OUTPUT_CHANNEL}/${VERSION}"
                  function tag_exists() {
                    git tag --list | grep -q "^$1$"
                  }
                  function fetch_tag() {
                    git fetch origin "refs/tags/$1:refs/tags/$1"
                  }
                  function delete_tag() {
                    git push --delete origin "$1"
                  }
                  function create_tag() {
                    git tag --force "$1"
                    git push --tags
                  }

                  fetch_tag "$TAG_NAME" || true
                  if tag_exists "$TAG_NAME"; then
                    delete_tag "$TAG_NAME"
                  fi
                  create_tag "$TAG_NAME"
