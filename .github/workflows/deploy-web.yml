name: Deploy Web to Vercel
env:
    VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
on:
    # Runs on pushes targeting the main branch
    push:
        branches: ['main']
        paths:
            - 'apps/web/**'
            - '.github/workflows/deploy-web.yml'

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
    contents: read
    pages: write
    id-token: write

# Allow only one concurrent deployment
concurrency:
    group: 'vercel'
    cancel-in-progress: true

env:
    NODE_VERSION: 'lts/jod' # Set this to the node version to use

jobs:
    # Build job
    build:
        runs-on: ubuntu-latest
        environment:
            name: vercel
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Vercel CLI
              run: npm install --global vercel@latest

            - name: Pull Vercel Environment Information
              run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

            - name: Pull Git LFS files
              run: git lfs pull

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate proto types
              run: pnpm proto:typescript

            - name: Build Project Artifacts
              run: vercel build --token=${{ secrets.VERCEL_TOKEN }} --filter @eurora/web...
              env:
                  VITE_API_BASE_URL: 'https://api.eurora-labs.com'

            - name: Deploy Project Artifacts to Vercel
              run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

            # - name: Build web app
            #   run: pnpm turbo run build --filter @eurora/web...
            #   env:
            #       VITE_API_BASE_URL: 'https://api.eurora-labs.com'

            # - name: Create CNAME file
            #   run: echo "eurora-labs.com" > apps/web/dist/CNAME

            # - name: Setup Pages
            #   uses: actions/configure-pages@v5
            #   with:
            #       static_site_generator: sveltekit

    #         - name: Upload artifact
    #           uses: actions/upload-pages-artifact@v3
    #           with:
    #               path: 'apps/web/dist'

    # # Deployment job
    # deploy:
    #     runs-on: ubuntu-latest
    #     needs: build
    #     steps:
    #         - name: Deploy Project Artifacts to Vercel
    #           run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
    #         # - name: Deploy to GitHub Pages
    #         #   id: deployment
    #         #   uses: actions/deploy-pages@v4
