name: Deploy Web to AWS Amplify

on:
    # Runs on pushes targeting the main branch
    push:
        branches: ['main']
        paths:
            - 'apps/web/**'
            - 'packages/**'
            - '.github/workflows/deploy-web.yml'

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

permissions:
    contents: write

# Allow only one concurrent deployment
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: 'lts/jod'
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    AWS_DEFAULT_REGION: us-west-2
    AWS_DEFAULT_OUTPUT: json
    DEPLOY_BRANCH: deploy-web

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        environment: amplify-web
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0
                  lfs: true

            - name: Install pnpm
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

            - name: Setup Node.js
              uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install

            - name: Create web environment file
              run: |
                  echo "PUBLIC_STRIPE_KEY=${{ secrets.PUBLIC_STRIPE_KEY }}" >> apps/web/.env
                  echo "SECRET_STRIPE_KEY=${{ secrets.SECRET_STRIPE_KEY }}" >> apps/web/.env

            - name: Generate protobuf types
              run: pnpm proto:typescript

            - name: Build shared packages
              run: pnpm build

            - name: Build web application
              run: pnpm build:web

            - name: Push to deploy branch
              run: |
                  # Configure git
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  
                  # Create a temporary directory for the deploy branch
                  DEPLOY_DIR=$(mktemp -d)
                  
                  # Copy built artifacts to temp directory
                  cp -r apps/web/build/* "$DEPLOY_DIR/"
                  
                  # Create amplify.yml for the deploy branch (no build needed)
                  cat > "$DEPLOY_DIR/amplify.yml" << 'EOF'
                  version: 1
                  frontend:
                    phases:
                      build:
                        commands:
                          - echo "Using pre-built artifacts"
                    artifacts:
                      baseDirectory: /
                      files:
                        - '**/*'
                  EOF
                  
                  # Switch to deploy branch (create if doesn't exist)
                  git checkout --orphan ${{ env.DEPLOY_BRANCH }}-temp || git checkout ${{ env.DEPLOY_BRANCH }}-temp
                  git rm -rf . || true
                  
                  # Copy artifacts back
                  cp -r "$DEPLOY_DIR"/* .
                  
                  # Commit and push
                  git add -A
                  git commit -m "Deploy from ${{ github.sha }}"
                  git push origin HEAD:${{ env.DEPLOY_BRANCH }} --force
                  
                  # Cleanup
                  rm -rf "$DEPLOY_DIR"

            - name: Trigger Amplify deployment
              id: deployment
              run: chmod +x ./scripts/amplify-deploy.sh && ./scripts/amplify-deploy.sh ${{ secrets.AMPLIFY_APP_ID }} ${{ env.DEPLOY_BRANCH }}
