name: 'Publish'
env:
    RUSTUP_TOOLCHAIN: stable
permissions:
    contents: read # Required for checkout
    actions: read # Required for downloading artifacts
on:
    schedule:
        # every day at 1am UTC, 3AM CEST or 2AM CET.
        - cron: '0 1 * * *'
    workflow_run:
        workflows: ['Nightly build']
        types:
            - completed

    workflow_dispatch:
        inputs:
            channel:
                type: choice
                required: true
                description: channel
                default: nightly
                options:
                    - release
                    - nightly
            bump:
                type: choice
                required: true
                description: update type
                default: patch
                options:
                    - undefined
                    - patch
                    - minor
                    - major

jobs:
    build-sveltekit:
        runs-on: ubuntu-latest
        environment:
            name: eurora-main-app
        env:
            SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        steps:
            - name: Trigger Sentry Cron - In Progress
              if: ${{ github.event_name == 'schedule' }}
              shell: bash
              env:
                  SENTRY_CRONS_URL: ${{ secrets.SENTRY_CRONS }}
              run: curl "${SENTRY_CRONS_URL}?status=in_progress"

            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Consume input variables
              shell: bash
              if: ${{ !github.event.workflow_run }}
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  VITEMODE=nightly
                  if [[ "$INPUT_CHANNEL" == "release" ]]; then
                    VITEMODE=production
                  fi

                  echo "vitemode=$VITEMODE" >> $GITHUB_ENV
                  echo "channel=$INPUT_CHANNEL" >> $GITHUB_ENV
                  echo "bump=$INPUT_BUMP" >> $GITHUB_ENV

            - name: Calculate next version
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  BUMP_TYPE: ${{ env.bump }}
              run: |
                  CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/releases/${RELEASE_CHANNEL}" | jq -r '.version')"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP_TYPE}")
                  echo "version=$NEXT_VERSION" >> $GITHUB_ENV
                  mkdir -p release && echo "$NEXT_VERSION" > release/version

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - name: Build SvelteKit
              env:
                  SENTRY_RELEASE: ${{ env.version }}
                  VITE_MODE: ${{ env.vitemode }}
              run: pnpm build:desktop -- --mode "$VITE_MODE"

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              name: Upload pnpm-store contents
              with:
                  name: pnpm-store
                  path: /home/runner/setup-pnpm/node_modules/.bin/store/v3
                  retention-days: 7

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              name: Upload SvelteKit build output
              with:
                  name: sveltekit-build
                  path: ./apps/desktop/build/
                  retention-days: 1
                  if-no-files-found: error

    build-tauri:
        needs: build-sveltekit
        env:
            CARGO_TERM_COLOR: always
        strategy:
            fail-fast: false
            matrix:
                # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#standard-github-hosted-runners-for-private-repositories
                include:
                    - platform: macos-15 # [macOs, ARM64] - default target
                      target: ''
                    - platform: macos-15 # [macOs, x64] - cross-compile
                      target: x86_64-apple-darwin
                    - platform: ubuntu-24.04 # [linux, x64]
                      target: ''
                    - platform: ubuntu-24.04-arm # [linux, ARM64]
                      target: ''
                    - platform: windows-latest # [windows, x64]
                      target: ''

        runs-on: ${{ matrix.platform }}

        outputs:
            platform: ${{ matrix.platform }}
            channel: ${{ env.channel }}

        steps:
            # Because GitHub broke perl installations sometime in 2022 on Windows.
            - name: perl -V (before re-install)
              if: runner.os == 'Windows'
              run: which perl && perl -V

            - name: Set git to use LF
              if: runner.os == 'Windows'
              run: |
                  git config --global core.autocrlf false
                  git config --global core.eol lf

            - name: perl -V
              if: runner.os == 'Windows'
              run: which perl && perl -V

            - name: Set Perl environment variables
              if: runner.os == 'Windows'
              run: |
                  echo "PERL=$((where.exe perl)[0])" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
                  echo "OPENSSL_SRC_PERL=$((where.exe perl)[0])" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Set Cargo build target
              shell: bash
              if: matrix.target != ''
              env:
                  BUILD_TARGET: ${{ matrix.target }}
              run: |
                  echo "CARGO_BUILD_TARGET=$BUILD_TARGET" >> $GITHUB_ENV
                  rustup target add "$BUILD_TARGET"

            # The cache doesn't pick up the environment variable set above, so we have to set it ourselves.
            - name: Rust Cache
              uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
              with:
                  shared-key: app-release-build-${{ github.event.inputs.channel || 'nightly' }}${{ matrix.target }}

            - name: Install cargo-about
              shell: bash
              run: |
                  if ! command -v cargo-about >/dev/null 2>&1; then
                  cargo install --locked "cargo-about@^0.8"
                  fi

            - name: Generate third-party license bundle
              shell: bash
              run: ./scripts/generate-licenses ./LICENSES-THIRD-PARTY.md

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Consume input variables
              shell: bash
              if: ${{ !github.event.workflow_run }}
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  echo "channel=$INPUT_CHANNEL" >> $GITHUB_ENV
                  echo "bump=$INPUT_BUMP" >> $GITHUB_ENV

            - name: Calculate next version
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  BUMP_TYPE: ${{ env.bump }}
              run: |
                  CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/releases/${RELEASE_CHANNEL}" | jq -r '.version')"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP_TYPE}")
                  echo "version=$NEXT_VERSION" >> $GITHUB_ENV
                  mkdir -p release && echo "$NEXT_VERSION" > release/version

            # - name: Import GPG key
            #   if: runner.os == 'Linux'
            #   uses: crazy-max/ghaction-import-gpg@v6
            #   with:
            #       gpg_private_key: ${{ secrets.APPIMAGE_PRIVATE_KEY }}
            #       passphrase: ${{ secrets.APPIMAGE_KEY_PASSPHRASE }}

            - name: Install linux dependencies
              shell: bash
              if: runner.os == 'Linux'
              run: |
                  sudo apt update;
                  sudo apt install -y \
                    build-essential \
                    curl \
                    wget \
                    file \
                    libssl-dev \
                    libgtk-3-dev \
                    libappindicator3-dev \
                    librsvg2-dev \
                    xdg-utils;

                  sudo apt install -y \
                    libwebkit2gtk-4.1-0 \
                    libwebkit2gtk-4.1-dev \
                    libgbm-dev \
                    libjavascriptcoregtk-4.1-0 \
                    libjavascriptcoregtk-4.1-dev \
                    gir1.2-javascriptcoregtk-4.1 \
                    gir1.2-webkit2-4.1 \
                    libpipewire-0.3-dev;

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              name: Download SvelteKit build output
              with:
                  name: sveltekit-build
                  path: ./apps/desktop/build/

            - name: Set release build optimization env vars
              shell: bash
              if: github.event.inputs.channel == 'release'
              run: |
                  echo "CARGO_PROFILE_RELEASE_LTO=fat" >> $GITHUB_ENV
                  echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1" >> $GITHUB_ENV
                  echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=s" >> $GITHUB_ENV

            - name: Build binary
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  RELEASE_VERSION: ${{ env.version }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
                  APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
                  APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_PROVIDER_SHORT_NAME }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
                  APPIMAGE_KEY_ID: ${{ secrets.APPIMAGE_KEY_ID }}
                  APPIMAGE_KEY_PASSPHRASE: ${{ secrets.APPIMAGE_KEY_PASSPHRASE }}
                  POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
              run: |
                  ./scripts/release.sh \
                    --channel                    "$RELEASE_CHANNEL" \
                    --dist                       "./release" \
                    --version                    "$RELEASE_VERSION"

            - name: Set artifact name suffix
              shell: bash
              env:
                  BUILD_TARGET: ${{ matrix.target }}
              run: |
                  # Only add suffix for macOS x86_64 to distinguish from ARM64
                  if [ "$BUILD_TARGET" = "x86_64-apple-darwin" ]; then
                    echo "artifact_suffix=-x86_64" >> $GITHUB_ENV
                  else
                    echo "artifact_suffix=" >> $GITHUB_ENV
                  fi

            - name: Upload Artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: '${{ env.channel }}-${{ matrix.platform }}${{ env.artifact_suffix }}-${{ github.run_number }}'
                  path: release/
                  if-no-files-found: error

    publish-tauri:
        needs: [build-tauri]
        runs-on: ubuntu-latest
        outputs:
            version: ${{ env.version }}
        strategy:
            fail-fast: false
            matrix:
                # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#standard-github-hosted-runners-for-private-repositories
                include:
                    - platform: macos-15 # [macOs, ARM64] - default target
                      target: ''
                    - platform: macos-15 # [macOs, x64] - cross-compile
                      target: x86_64-apple-darwin
                    - platform: ubuntu-24.04 # [linux, x64]
                      target: ''
                    - platform: ubuntu-24.04-arm # [linux, ARM64]
                      target: ''
                    - platform: windows-latest # [windows, x64]
                      target: ''
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true
            - name: Set artifact name suffix
              shell: bash
              env:
                  BUILD_TARGET: ${{ matrix.target }}
              run: |
                  # Only add suffix for macOS x86_64 to distinguish from ARM64
                  if [ "$BUILD_TARGET" = "x86_64-apple-darwin" ]; then
                    echo "artifact_suffix=-x86_64" >> $GITHUB_ENV
                  else
                    echo "artifact_suffix=" >> $GITHUB_ENV
                  fi
            - name: Download artifacts
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: '${{ needs.build-tauri.outputs.channel }}-${{ matrix.platform }}${{ env.artifact_suffix }}-${{ github.run_number }}'
                  path: release
            - name: Extract version
              shell: bash
              run: |
                  VERSION="$(cat release/version)"
                  echo "version=$VERSION" >> $GITHUB_ENV
            - name: Prepare S3 payload
              shell: bash
              run: |
                  rm -rf release-s3
                  mkdir -p release-s3
                  rsync -avE --prune-empty-dirs --include-from='.github/workflows/publish.include.txt' --exclude='*' release/ release-s3/
                  bash scripts/normalize-spaces.sh ./release-s3

            - uses: shallwefootball/s3-upload-action@0d261a6f15b3b2e209dfebdecace4b100c04f95b # master
              name: Upload To S3
              id: S3
              with:
                  aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws_bucket: 'releases.eurora-labs.com'
                  source_dir: 'release-s3/'
                  destination_dir: 'releases/${{ needs.build-tauri.outputs.channel }}/${{ env.version }}-${{ github.run_number }}'

            # tell our server to update with the version number
        #   - name: Notify Eurora API of new release
        #     shell: bash
        #     if: secrets.BOT_AUTH_TOKEN != ''
        #     run: |
        #       curl 'https://app.eurora.com/api/releases' \
        #         --fail \
        #         --request POST \
        #         --header 'Content-Type: application/json' \
        #         --header 'X-Auth-Token: ${{ secrets.BOT_AUTH_TOKEN }}' \
        #         --data '{"channel":"${{ needs.build-tauri.outputs.channel }}","version":"${{ env.version }}-${{ github.run_number }}","sha":"${{ github.sha }}"}'

    create-git-tag:
        needs: [publish-tauri, build-tauri]
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required for creating and pushing git tags
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true
            - name: Create git tag
              shell: bash
              env:
                  TAG_NAME: '${{ needs.build-tauri.outputs.channel }}/${{ needs.publish-tauri.outputs.version }}'
              run: |
                  function tag_exists() {
                    git tag --list | grep -q "^$1$"
                  }
                  function fetch_tag() {
                    git fetch origin "refs/tags/$1:refs/tags/$1"
                  }
                  function delete_tag() {
                    git push --delete origin "$1"
                  }
                  function create_tag() {
                    git tag --force "$1"
                    git push --tags
                  }

                  fetch_tag "$TAG_NAME" || true
                  if tag_exists "$TAG_NAME"; then
                    delete_tag "$TAG_NAME"
                  fi
                  create_tag "$TAG_NAME"
            - name: Trigger Sentry Cron - Complete
              if: ${{ github.event_name == 'schedule' }}
              shell: bash
              env:
                  SENTRY_CRONS_URL: ${{ secrets.SENTRY_CRONS }}
              run: curl "${SENTRY_CRONS_URL}?status=ok"
