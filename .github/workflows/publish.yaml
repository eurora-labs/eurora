name: 'Publish'
env:
    RUSTUP_TOOLCHAIN: stable
permissions:
    contents: read # Required for checkout
    actions: read # Required for downloading artifacts
on:
    schedule:
        # every day at 1am UTC, 3AM CEST or 2AM CET.
        - cron: '0 1 * * *'
    workflow_run:
        workflows: ['Nightly build']
        types:
            - completed

    workflow_dispatch:
        inputs:
            channel:
                type: choice
                required: true
                description: channel
                default: nightly
                options:
                    - release
                    - nightly
            bump:
                type: choice
                required: true
                description: update type
                default: patch
                options:
                    - undefined
                    - patch
                    - minor
                    - major

jobs:
    build-sveltekit:
        runs-on: ubuntu-latest
        environment:
            name: eurora-main-app
        env:
            SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        steps:
            - name: Trigger Sentry Cron - In Progress
              if: ${{ github.event_name == 'schedule' }}
              shell: bash
              env:
                  SENTRY_CRONS_URL: ${{ secrets.SENTRY_CRONS }}
              run: curl "${SENTRY_CRONS_URL}?status=in_progress"

            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Consume input variables
              shell: bash
              if: ${{ !github.event.workflow_run }}
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  VITEMODE=nightly
                  if [[ "$INPUT_CHANNEL" == "release" ]]; then
                    VITEMODE=production
                  fi

                  {
                    echo 'vitemode<<EOF'
                    echo "$VITEMODE"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  {
                    echo 'channel<<EOF'
                    echo "$INPUT_CHANNEL"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  {
                    echo 'bump<<EOF'
                    echo "$INPUT_BUMP"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"

            - name: Calculate next version
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  BUMP_TYPE: ${{ env.bump }}
              run: |
                  CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/releases/${RELEASE_CHANNEL}" | jq -r '.version')"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP_TYPE}")
                  {
                    echo 'version<<EOF'
                    echo "$NEXT_VERSION"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  mkdir -p release && echo "$NEXT_VERSION" > release/version

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - name: Build SvelteKit
              env:
                  SENTRY_RELEASE: ${{ env.version }}
                  VITE_MODE: ${{ env.vitemode }}
              run: pnpm build:desktop -- --mode "$VITE_MODE"

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              name: Upload pnpm-store contents
              with:
                  name: pnpm-store
                  path: /home/runner/setup-pnpm/node_modules/.bin/store/v3
                  retention-days: 7

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              name: Upload SvelteKit build output
              with:
                  name: sveltekit-build
                  path: ./apps/desktop/build/
                  retention-days: 1
                  if-no-files-found: error

    build-tauri:
        needs: build-sveltekit
        env:
            CARGO_TERM_COLOR: always
        strategy:
            fail-fast: false
            matrix:
                # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#standard-github-hosted-runners-for-private-repositories
                include:
                    - platform: macos-15 # [macOs, ARM64] - default target
                      target: ''
                    - platform: macos-15 # [macOs, x64] - cross-compile
                      target: x86_64-apple-darwin
                    - platform: ubuntu-24.04 # [linux, x64]
                      target: ''
                    - platform: ubuntu-24.04-arm # [linux, ARM64]
                      target: ''
                    - platform: windows-latest # [windows, x64]
                      target: ''

        runs-on: ${{ matrix.platform }}

        outputs:
            platform: ${{ matrix.platform }}
            channel: ${{ env.channel }}

        steps:
            # Because GitHub broke perl installations sometime in 2022 on Windows.
            - name: perl -V (before re-install)
              if: runner.os == 'Windows'
              run: which perl && perl -V

            - name: Set git to use LF
              if: runner.os == 'Windows'
              run: |
                  git config --global core.autocrlf false
                  git config --global core.eol lf

            - name: perl -V
              if: runner.os == 'Windows'
              run: which perl && perl -V

            - name: Set Perl environment variables
              if: runner.os == 'Windows'
              run: |
                  $perlPath = (where.exe perl)[0]
                  "PERL<<EOF" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
                  $perlPath | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
                  "EOF" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
                  "OPENSSL_SRC_PERL<<EOF" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
                  $perlPath | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
                  "EOF" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Set Cargo build target
              shell: bash
              if: matrix.target != ''
              env:
                  BUILD_TARGET: ${{ matrix.target }}
              run: |
                  {
                    echo 'CARGO_BUILD_TARGET<<EOF'
                    echo "$BUILD_TARGET"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  rustup target add "$BUILD_TARGET"

            # The cache doesn't pick up the environment variable set above, so we have to set it ourselves.
            - name: Rust Cache
              uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
              with:
                  shared-key: app-release-build-${{ github.event.inputs.channel || 'nightly' }}${{ matrix.target }}

            - name: Install cargo-about
              shell: bash
              run: |
                  if ! command -v cargo-about >/dev/null 2>&1; then
                  cargo install --locked "cargo-about@^0.8"
                  fi

            - name: Generate third-party license bundle
              shell: bash
              run: ./scripts/generate-licenses ./crates/app/euro-tauri/LICENSES-THIRD-PARTY.md

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Consume input variables
              shell: bash
              if: ${{ !github.event.workflow_run }}
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  {
                    echo 'channel<<EOF'
                    echo "$INPUT_CHANNEL"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  {
                    echo 'bump<<EOF'
                    echo "$INPUT_BUMP"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"

            - name: Calculate next version
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  BUMP_TYPE: ${{ env.bump }}
              run: |
                  CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/releases/${RELEASE_CHANNEL}" | jq -r '.version')"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP_TYPE}")
                  {
                    echo 'version<<EOF'
                    echo "$NEXT_VERSION"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  mkdir -p release && echo "$NEXT_VERSION" > release/version

            # - name: Import GPG key
            #   if: runner.os == 'Linux'
            #   uses: crazy-max/ghaction-import-gpg@v6
            #   with:
            #       gpg_private_key: ${{ secrets.APPIMAGE_PRIVATE_KEY }}
            #       passphrase: ${{ secrets.APPIMAGE_KEY_PASSPHRASE }}

            - name: Install linux dependencies
              shell: bash
              if: runner.os == 'Linux'
              run: |
                  sudo apt update;
                  sudo apt install -y \
                    build-essential \
                    curl \
                    wget \
                    file \
                    libssl-dev \
                    libgtk-3-dev \
                    libappindicator3-dev \
                    librsvg2-dev \
                    xdg-utils;

                  sudo apt install -y \
                    libwebkit2gtk-4.1-0 \
                    libwebkit2gtk-4.1-dev \
                    libgbm-dev \
                    libjavascriptcoregtk-4.1-0 \
                    libjavascriptcoregtk-4.1-dev \
                    gir1.2-javascriptcoregtk-4.1 \
                    gir1.2-webkit2-4.1 \
                    libpipewire-0.3-dev;

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              name: Download SvelteKit build output
              with:
                  name: sveltekit-build
                  path: ./apps/desktop/build/

            - name: Set release build optimization env vars
              shell: bash
              if: github.event.inputs.channel == 'release'
              run: |
                  {
                    echo 'CARGO_PROFILE_RELEASE_LTO<<EOF'
                    echo "fat"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  {
                    echo 'CARGO_PROFILE_RELEASE_CODEGEN_UNITS<<EOF'
                    echo "1"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  {
                    echo 'CARGO_PROFILE_RELEASE_OPT_LEVEL<<EOF'
                    echo "s"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"

            - name: Build binary
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  RELEASE_VERSION: ${{ env.version }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
                  APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
                  APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_PROVIDER_SHORT_NAME }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
                  APPIMAGE_KEY_ID: ${{ secrets.APPIMAGE_KEY_ID }}
                  APPIMAGE_KEY_PASSPHRASE: ${{ secrets.APPIMAGE_KEY_PASSPHRASE }}
                  POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
              run: |
                  ./scripts/release.sh \
                    --channel                    "$RELEASE_CHANNEL" \
                    --dist                       "./release" \
                    --version                    "$RELEASE_VERSION"

            - name: Set artifact name suffix
              shell: bash
              env:
                  BUILD_TARGET: ${{ matrix.target }}
              run: |
                  # Only add suffix for macOS x86_64 to distinguish from ARM64
                  if [ "$BUILD_TARGET" = "x86_64-apple-darwin" ]; then
                    {
                      echo 'artifact_suffix<<EOF'
                      echo "-x86_64"
                      echo 'EOF'
                    } >> "$GITHUB_ENV"
                  else
                    {
                      echo 'artifact_suffix<<EOF'
                      echo ""
                      echo 'EOF'
                    } >> "$GITHUB_ENV"
                  fi

            - name: Upload Artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: '${{ env.channel }}-${{ matrix.platform }}${{ env.artifact_suffix }}-${{ github.run_number }}'
                  path: release/
                  if-no-files-found: error

    build-safari-extension:
        needs: build-sveltekit
        runs-on: macos-15
        strategy:
            fail-fast: false
            matrix:
                include:
                    - arch: arm64
                      xcode_arch: arm64
                    - arch: x86_64
                      xcode_arch: x86_64
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Consume input variables
              shell: bash
              if: ${{ !github.event.workflow_run }}
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  {
                    echo 'channel<<EOF'
                    echo "$INPUT_CHANNEL"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
                  {
                    echo 'bump<<EOF'
                    echo "$INPUT_BUMP"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"

            - name: Calculate next version
              shell: bash
              env:
                  RELEASE_CHANNEL: ${{ env.channel }}
                  BUMP_TYPE: ${{ env.bump }}
              run: |
                  CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/releases/${RELEASE_CHANNEL}" | jq -r '.version')"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP_TYPE}")
                  {
                    echo 'version<<EOF'
                    echo "$NEXT_VERSION"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install Swift protoc plugins
              run: |
                  brew install swift-protobuf protoc-gen-grpc-swift
                  echo "$(brew --prefix)/bin" >> "$GITHUB_PATH"

            - name: Compile Protobuf
              run: pnpm proto:typescript && pnpm proto:swift

            - name: Build Safari browser extension
              run: pnpm build:safari

            - name: Import Apple certificate
              shell: bash
              env:
                  APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
                  APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
              run: |
                  CERTIFICATE_PATH="$RUNNER_TEMP/build_certificate.p12"
                  KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
                  KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

                  echo -n "$APPLE_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"

                  security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
                  security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
                  security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
                  security import "$CERTIFICATE_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
                  security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
                  security list-keychain -d user -s "$KEYCHAIN_PATH"

            - name: Resolve Swift packages
              shell: bash
              working-directory: apps/macos
              run: xcodebuild -resolvePackageDependencies -project macos.xcodeproj -scheme macos

            - name: Build and archive Safari extension
              shell: bash
              working-directory: apps/macos
              env:
                  APPLE_TEAM_ID: ${{ secrets.APPLE_PROVIDER_SHORT_NAME }}
              run: |
                  xcodebuild archive \
                    -project macos.xcodeproj \
                    -scheme macos \
                    -configuration Release \
                    -archivePath "$RUNNER_TEMP/EuroraForSafari.xcarchive" \
                    -arch "${{ matrix.xcode_arch }}" \
                    ONLY_ACTIVE_ARCH=NO \
                    CODE_SIGN_STYLE=Manual \
                    CODE_SIGN_IDENTITY="Developer ID Application" \
                    DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
                    MARKETING_VERSION="${{ env.version }}" \
                    CURRENT_PROJECT_VERSION="${{ github.run_number }}" \
                    OTHER_CODE_SIGN_FLAGS="--timestamp"

            - name: Export archive
              shell: bash
              run: |
                  cat > "$RUNNER_TEMP/ExportOptions.plist" << 'PLIST'
                  <?xml version="1.0" encoding="UTF-8"?>
                  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                  <plist version="1.0">
                  <dict>
                      <key>method</key>
                      <string>developer-id</string>
                      <key>teamID</key>
                      <string>${{ secrets.APPLE_PROVIDER_SHORT_NAME }}</string>
                  </dict>
                  </plist>
                  PLIST

                  xcodebuild -exportArchive \
                    -archivePath "$RUNNER_TEMP/EuroraForSafari.xcarchive" \
                    -exportPath "$RUNNER_TEMP/export" \
                    -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"

            - name: Notarize app
              shell: bash
              env:
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_PROVIDER_SHORT_NAME }}
                  APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
              run: |
                  APP_PATH="$RUNNER_TEMP/export/macos.app"

                  # Create a zip for notarization
                  ditto -c -k --keepParent "$APP_PATH" "$RUNNER_TEMP/macos-notarize.zip"

                  xcrun notarytool submit "$RUNNER_TEMP/macos-notarize.zip" \
                    --apple-id "$APPLE_ID" \
                    --team-id "$APPLE_TEAM_ID" \
                    --password "$APPLE_PASSWORD" \
                    --wait

                  # Staple the notarization ticket
                  xcrun stapler staple "$APP_PATH"

            - name: Prepare release artifacts
              shell: bash
              run: |
                  if [ "${{ matrix.arch }}" = "arm64" ]; then
                    ARCH_DIR="aarch64"
                  else
                    ARCH_DIR="x86_64"
                  fi

                  RELEASE_DIR="release/darwin/$ARCH_DIR"
                  mkdir -p "$RELEASE_DIR"

                  # Create a zip of the signed+notarized app
                  ditto -c -k --keepParent "$RUNNER_TEMP/export/macos.app" "$RELEASE_DIR/EuroraForSafari.app.zip"

                  echo "${{ env.version }}" > release/version

            - name: Upload Safari extension artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: 'safari-${{ matrix.arch }}-${{ github.run_number }}'
                  path: release/
                  if-no-files-found: error

    publish-tauri:
        needs: [build-tauri, build-safari-extension]
        runs-on: ubuntu-latest
        outputs:
            version: ${{ env.version }}
        strategy:
            fail-fast: false
            matrix:
                # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners/about-github-hosted-runners#standard-github-hosted-runners-for-private-repositories
                include:
                    - platform: macos-15 # [macOs, ARM64] - default target
                      target: ''
                    - platform: macos-15 # [macOs, x64] - cross-compile
                      target: x86_64-apple-darwin
                    - platform: ubuntu-24.04 # [linux, x64]
                      target: ''
                    - platform: ubuntu-24.04-arm # [linux, ARM64]
                      target: ''
                    - platform: windows-latest # [windows, x64]
                      target: ''
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true
            - name: Set artifact name suffix
              shell: bash
              env:
                  BUILD_TARGET: ${{ matrix.target }}
              run: |
                  # Only add suffix for macOS x86_64 to distinguish from ARM64
                  if [ "$BUILD_TARGET" = "x86_64-apple-darwin" ]; then
                    {
                      echo 'artifact_suffix<<EOF'
                      echo "-x86_64"
                      echo 'EOF'
                    } >> "$GITHUB_ENV"
                  else
                    {
                      echo 'artifact_suffix<<EOF'
                      echo ""
                      echo 'EOF'
                    } >> "$GITHUB_ENV"
                  fi
            - name: Download artifacts
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: '${{ needs.build-tauri.outputs.channel }}-${{ matrix.platform }}${{ env.artifact_suffix }}-${{ github.run_number }}'
                  path: release
            - name: Download Safari extension artifacts (ARM64)
              if: matrix.platform == 'macos-15' && matrix.target == ''
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: 'safari-arm64-${{ github.run_number }}'
                  path: release
                  merge-multiple: true
            - name: Download Safari extension artifacts (x86_64)
              if: matrix.platform == 'macos-15' && matrix.target == 'x86_64-apple-darwin'
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: 'safari-x86_64-${{ github.run_number }}'
                  path: release
                  merge-multiple: true
            - name: Extract version
              shell: bash
              run: |
                  VERSION="$(cat release/version)"
                  {
                    echo 'version<<EOF'
                    echo "$VERSION"
                    echo 'EOF'
                  } >> "$GITHUB_ENV"
            - name: Prepare S3 payload
              shell: bash
              run: |
                  rm -rf release-s3
                  mkdir -p release-s3
                  rsync -avE --prune-empty-dirs --include-from='.github/workflows/publish.include.txt' --exclude='*' release/ release-s3/
                  bash scripts/normalize-spaces.sh ./release-s3

            - uses: shallwefootball/s3-upload-action@0d261a6f15b3b2e209dfebdecace4b100c04f95b # master
              name: Upload To S3
              id: S3
              with:
                  aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws_bucket: 'releases.eurora-labs.com'
                  source_dir: 'release-s3/'
                  destination_dir: 'releases/${{ needs.build-tauri.outputs.channel }}/${{ env.version }}-${{ github.run_number }}'

            # tell our server to update with the version number
        #   - name: Notify Eurora API of new release
        #     shell: bash
        #     if: secrets.BOT_AUTH_TOKEN != ''
        #     run: |
        #       curl 'https://app.eurora.com/api/releases' \
        #         --fail \
        #         --request POST \
        #         --header 'Content-Type: application/json' \
        #         --header 'X-Auth-Token: ${{ secrets.BOT_AUTH_TOKEN }}' \
        #         --data '{"channel":"${{ needs.build-tauri.outputs.channel }}","version":"${{ env.version }}-${{ github.run_number }}","sha":"${{ github.sha }}"}'

    create-git-tag:
        needs: [publish-tauri, build-tauri]
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required for creating and pushing git tags
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true
            - name: Create git tag
              shell: bash
              env:
                  TAG_NAME: '${{ needs.build-tauri.outputs.channel }}/${{ needs.publish-tauri.outputs.version }}'
              run: |
                  function tag_exists() {
                    git tag --list | grep -q "^$1$"
                  }
                  function fetch_tag() {
                    git fetch origin "refs/tags/$1:refs/tags/$1"
                  }
                  function delete_tag() {
                    git push --delete origin "$1"
                  }
                  function create_tag() {
                    git tag --force "$1"
                    git push --tags
                  }

                  fetch_tag "$TAG_NAME" || true
                  if tag_exists "$TAG_NAME"; then
                    delete_tag "$TAG_NAME"
                  fi
                  create_tag "$TAG_NAME"
            - name: Trigger Sentry Cron - Complete
              if: ${{ github.event_name == 'schedule' }}
              shell: bash
              env:
                  SENTRY_CRONS_URL: ${{ secrets.SENTRY_CRONS }}
              run: curl "${SENTRY_CRONS_URL}?status=ok"
