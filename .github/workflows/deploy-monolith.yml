name: Deploy Monolith Backend

on:
    push:
        branches: ['main']
        paths:
            - 'crates/backend/euro-monolith/**'
            - 'crates/backend/euro-auth-service/**'
            - 'crates/backend/euro-ocr-service/**'
            - 'crates/backend/euro-remote-db/**'
            - 'crates/common/euro-auth/**'
            - 'proto/**'
            - '.github/workflows/deploy-monolith.yml'
    workflow_dispatch:

permissions:
    id-token: write
    contents: read
    packages: write

concurrency:
    group: 'monolith-deploy'
    cancel-in-progress: true

env:
    RUST_VERSION: nightly
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/euro-monolith

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  persist-credentials: false

            - uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
              with:
                  toolchain: nightly
                  components: rustfmt, clippy

            - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
              with:
                  workspaces: 'crates/backend/euro-monolith'

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler libglib2.0-dev libgtk-3-dev \
                    libpango1.0-dev libatk1.0-dev libgdk-pixbuf-2.0-dev libcairo2-dev \
                    pkg-config libjavascriptcoregtk-4.1-dev libsoup-3.0-dev \
                    libwebkit2gtk-4.1-dev libpipewire-0.3-dev

            - run:
                  cargo fmt --all -- --check
                  # - name: Run clippy
                  # run: cargo clippy --all-targets --all-features -- -D warnings

                  # - name: Run tests
                  # run: cargo test --workspace

            - name: Build monolith
              run: cargo build --release --package euro-monolith

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
              with:
                  name: euro-monolith-binary
                  path: target/release/euro-monolith
                  retention-days: 7

    docker:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  persist-credentials: false

            - name: Download build artifact
              uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
              with:
                  name: euro-monolith-binary
                  path: ./target/release/

            - name: Make binary executable
              run: chmod +x ./target/release/euro-monolith

            - name: Create Dockerfile
              run: |
                  cat > Dockerfile << 'EOF'
                  FROM ubuntu:24.04
                  RUN apt-get update && apt-get install -y ca-certificates libssl3 && rm -rf /var/lib/apt/lists/*
                  RUN useradd -r -s /bin/false eurora
                  COPY target/release/euro-monolith /usr/local/bin/euro-monolith
                  RUN chown eurora:eurora /usr/local/bin/euro-monolith
                  USER eurora
                  EXPOSE 50051
                  ENV MONOLITH_ADDR=[::]:50051
                  HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 CMD timeout 3s bash -c "</dev/tcp/localhost/50051" || exit 1
                  CMD ["/usr/local/bin/euro-monolith"]
                  EOF

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

            - name: Log in to Container Registry
              uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=raw,value=${{ github.sha }}
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image to GHCR
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
              with:
                  context: .
                  push: true
                  load: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ecr-full-access
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: ecr-login
              uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2
            - name: Tag and push image to ECR
              run: |
                  IMAGE_SHA=${{ github.sha }}
                  SRC_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_SHA
                  ECR_REPO=${{ secrets.ECR_REPOSITORY }}
                  docker tag $SRC_IMAGE $ECR_REPO:$IMAGE_SHA
                  docker tag $SRC_IMAGE $ECR_REPO:latest
                  docker push $ECR_REPO:$IMAGE_SHA
                  docker push $ECR_REPO:latest
