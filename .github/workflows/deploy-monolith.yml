name: Deploy Monolith Backend

on:
    push:
        branches: ['main']
        paths:
            - 'crates/backend/**'
            - 'crates/common/**'
            - 'proto/**'
            - '.github/workflows/deploy-monolith.yml'
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: 'monolith-deploy'
    cancel-in-progress: true

env:
    RUSTUP_TOOLCHAIN: stable
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/be-monolith

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  persist-credentials: false

            - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
              with:
                  workspaces: 'crates/backend/be-monolith'

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler libglib2.0-dev libgtk-3-dev \
                    libpango1.0-dev libatk1.0-dev libgdk-pixbuf-2.0-dev libcairo2-dev \
                    pkg-config libjavascriptcoregtk-4.1-dev libsoup-3.0-dev \
                    libwebkit2gtk-4.1-dev libpipewire-0.3-dev

            - name: Build monolith
              run: cargo build --release --package be-monolith

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: be-monolith-binary
                  path: target/release/be-monolith
                  retention-days: 7

    docker:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: read
            id-token: write
            packages: write
        steps:
            - name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  persist-credentials: false

            - name: Download build artifact
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: be-monolith-binary
                  path: ./target/release/

            - name: Make binary executable
              run: chmod +x ./target/release/be-monolith

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

            - name: Log in to Container Registry
              uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=raw,value=${{ github.sha }}
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image to GHCR
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
              with:
                  context: .
                  file: crates/backend/be-monolith/Dockerfile
                  push: true
                  load: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                      ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ecr-full-access
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: ecr-login
              uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2
            - name: Tag and push image to ECR
              env:
                  IMAGE_SHA: ${{ github.sha }}
                  SRC_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  ECR_REPO: ${{ secrets.ECR_REPOSITORY }}
              run: |
                  docker tag "$SRC_IMAGE" "$ECR_REPO:$IMAGE_SHA"
                  docker tag "$SRC_IMAGE" "$ECR_REPO:latest"
                  docker push "$ECR_REPO:$IMAGE_SHA"
                  docker push "$ECR_REPO:latest"
