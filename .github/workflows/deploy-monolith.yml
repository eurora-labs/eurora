name: Deploy Monolith Backend

on:
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: 'monolith-deploy'
    cancel-in-progress: true

env:
    CARGO_INCREMENTAL: 0
    RUSTUP_TOOLCHAIN: stable
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/be-monolith

jobs:
    build:
        environment: monolith-deploy
        strategy:
            fail-fast: true
            matrix:
                include:
                    - runner: ubuntu-22.04
                      arch: amd64
                    - runner: ubuntu-22.04-arm
                      arch: arm64
        runs-on: ${{ matrix.runner }}
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  persist-credentials: false

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler libglib2.0-dev libgtk-3-dev \
                    libpango1.0-dev libatk1.0-dev libgdk-pixbuf-2.0-dev libcairo2-dev \
                    pkg-config libjavascriptcoregtk-4.1-dev libsoup-3.0-dev \
                    libwebkit2gtk-4.1-dev libpipewire-0.3-dev

            - name: Build monolith
              run: cargo build --release --package be-monolith

            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: be-monolith-binary-${{ matrix.arch }}
                  path: target/release/be-monolith
                  retention-days: 7

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

            - name: Log in to Container Registry
              uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

            - name: Build and push by digest
              id: docker-build
              uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
              with:
                  context: .
                  file: crates/backend/be-monolith/Dockerfile
                  platforms: linux/${{ matrix.arch }}
                  labels: ${{ steps.meta.outputs.labels }}
                  outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
                  cache-from: type=gha,scope=${{ matrix.arch }}
                  cache-to: type=gha,scope=${{ matrix.arch }},mode=max

            - name: Export digest
              env:
                  DIGEST: ${{ steps.docker-build.outputs.digest }}
              run: |
                  mkdir -p /tmp/digests
                  touch "/tmp/digests/${DIGEST#sha256:}"

            - name: Upload digest
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: digests-${{ matrix.arch }}
                  path: /tmp/digests/*
                  if-no-files-found: error
                  retention-days: 1

    merge:
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: read
            id-token: write
            packages: write
        steps:
            - name: Download digests
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  pattern: digests-*
                  merge-multiple: true
                  path: /tmp/digests

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

            - name: Log in to Container Registry
              uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create and push GHCR manifest
              working-directory: /tmp/digests
              env:
                  IMAGE_REF: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  SHA: ${{ github.sha }}
              run: |
                  TAGS="-t ${IMAGE_REF}:${SHA} -t ${IMAGE_REF}:latest"
                  docker buildx imagetools create $TAGS \
                    $(printf "${IMAGE_REF}@sha256:%s " *)

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
              with:
                  role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ecr-full-access
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: ecr-login
              uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2

            - name: Push to ECR
              working-directory: /tmp/digests
              env:
                  ECR_REPO: ${{ secrets.ECR_REPOSITORY }}
                  IMAGE_REF: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  SHA: ${{ github.sha }}
              run: |
                  TAGS="-t ${ECR_REPO}:${SHA} -t ${ECR_REPO}:latest"
                  docker buildx imagetools create $TAGS \
                    $(printf "${IMAGE_REF}@sha256:%s " *)
