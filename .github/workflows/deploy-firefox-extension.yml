name: Deploy Firefox Extension

on:
    # Manual trigger
    workflow_dispatch:
        inputs:
            channel:
                type: choice
                required: true
                description: Release channel
                default: production
                options:
                    - production
                    - beta
            version:
                type: string
                required: true
                description: Extension version (e.g., 0.1.0)

    # Trigger on tags matching extension release pattern
    push:
        tags:
            - 'firefox/v*.*.*'

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        environment:
            name: firefox-addons

        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - name: Extract version from input or tag
              id: version
              shell: bash
              env:
                  EVENT_NAME: ${{ github.event_name }}
                  GITHUB_REF: ${{ github.ref }}
                  INPUT_VERSION: ${{ github.event.inputs.version }}
              run: |
                  if [ "$EVENT_NAME" == "push" ]; then
                    # Extract version from tag (e.g., firefox/v0.1.0 -> 0.1.0)
                    VERSION="${GITHUB_REF#refs/tags/firefox/v}"
                  else
                    VERSION="$INPUT_VERSION"
                  fi
                  if ! [[ "$VERSION" =~ ^[0-9]+(\.[0-9]+){2}([-\+][0-9A-Za-z\.-]+)?$ ]]; then
                    echo "Invalid version: $VERSION" >&2
                    exit 1
                  fi
                  printf "version=%s\n" "$VERSION" >> "$GITHUB_OUTPUT"
                  echo "Firefox version: $VERSION"

            - name: Determine Firefox extension ID
              id: firefox-id
              shell: bash
              env:
                  EVENT_NAME: ${{ github.event_name }}
                  CHANNEL: ${{ github.event.inputs.channel }}
              run: |
                  # Use production ID for production channel or tag push, dev ID for beta
                  if [ "$EVENT_NAME" == "push" ] || [ "$CHANNEL" == "production" ]; then
                    FIREFOX_ID="{271903fe-1905-4636-b47f-6f0873dc97f8}"
                    echo "Using production Firefox extension ID"
                  else
                    FIREFOX_ID="dev@eurora-labs.com"
                    echo "Using development Firefox extension ID"
                  fi
                  printf "firefox_id=%s\n" "$FIREFOX_ID" >> "$GITHUB_OUTPUT"

            - name: Build Firefox extension
              run: pnpm run build:firefox
              env:
                  NODE_ENV: production
                  VERSION: ${{ steps.version.outputs.version }}
                  FIREFOX_EXTENSION_ID: ${{ steps.firefox-id.outputs.firefox_id }}

            - name: Create Firefox extension zip
              shell: bash
              run: |
                  cd apps/browser/dist/firefox
                  zip -r ../../../../firefox-extension.zip . -x "*.git*" -x "*.zip"
                  cd ../../../..
                  echo "Created firefox-extension.zip"
                  ls -lh firefox-extension.zip

            - name: Upload artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: firefox-extension-${{ steps.version.outputs.version }}
                  path: firefox-extension.zip
                  retention-days: 30

            - name: Install web-ext
              run: npm install -g web-ext@8.10.0

            - name: Sign and publish to Firefox Add-ons
              if: github.event.inputs.channel == 'production' || github.event_name == 'push'
              shell: bash
              env:
                  WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
                  WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
              run: |
                  cd apps/browser/dist/firefox

                  # Sign and submit the Firefox extension
                  web-ext sign \
                    --channel=listed \
                    --api-key="$WEB_EXT_API_KEY" \
                    --api-secret="$WEB_EXT_API_SECRET" \
                    --timeout=900000

                  echo "Extension signed and submitted to Firefox Add-ons store"

            - name: Sign for beta channel
              if: github.event.inputs.channel == 'beta'
              shell: bash
              env:
                  WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
                  WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
              run: |
                  cd apps/browser/dist/firefox

                  # Sign and submit to unlisted (beta) channel
                  web-ext sign \
                    --channel=unlisted \
                    --api-key="$WEB_EXT_API_KEY" \
                    --api-secret="$WEB_EXT_API_SECRET" \
                    --timeout=900000

                  echo "Extension signed for beta channel"

            - name: Create GitHub Release
              if: github.event_name == 'push'
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
              with:
                  files: |
                      apps/browser/dist/firefox/web-ext-artifacts/*.xpi
                      firefox-extension.zip
                  body: |
                      Firefox Extension Release ${{ steps.version.outputs.version }}

                      This release has been automatically built and submitted to the Firefox Add-ons store.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Notify on success
              if: success()
              run: |
                  echo "✅ Firefox extension ${{ steps.version.outputs.version }} successfully built and deployed!"

            - name: Notify on failure
              if: failure()
              run: |
                  echo "❌ Firefox extension deployment failed. Check the logs for details."
