name: 'Publish Firefox Extension'
env:
    RUSTUP_TOOLCHAIN: stable
permissions:
    contents: read # Required for checkout
    actions: read # Required for downloading artifacts
on:
    workflow_dispatch:
        inputs:
            channel:
                type: choice
                required: true
                description: channel
                default: nightly
                options:
                    - release
                    - nightly
            bump:
                type: choice
                required: true
                description: update type
                default: patch
                options:
                    - undefined
                    - patch
                    - minor
                    - major

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-firefox:
        runs-on: ubuntu-latest
        environment:
            name: firefox-addons

        outputs:
            version: ${{ env.version }}
            channel: ${{ env.channel }}

        steps:
            - name: Checkout code
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Consume input variables
              shell: bash
              env:
                  INPUT_CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  INPUT_BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  echo "channel=$INPUT_CHANNEL" >> $GITHUB_ENV
                  echo "bump=$INPUT_BUMP" >> $GITHUB_ENV

            - name: Calculate next version
              shell: bash
              env:
                  CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
                  BUMP: ${{ github.event.inputs.bump || 'patch' }}
              run: |
                  # Fetch current version from API
                  CURRENT_VERSION="$(curl --silent "https://api.eurora-labs.com/extensions/${CHANNEL}" | jq -r '.browsers.firefox.version // "0.5.0"')"
                  NEXT_VERSION=$(./scripts/next.sh "${CURRENT_VERSION}" "${BUMP}")
                  echo "version=$NEXT_VERSION" >> $GITHUB_ENV
                  mkdir -p release && echo "$NEXT_VERSION" > release/version
                  echo "Firefox extension version: $NEXT_VERSION (previous: $CURRENT_VERSION)"

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - name: Determine Firefox extension ID
              id: firefox-id
              shell: bash
              env:
                  CHANNEL: ${{ github.event.inputs.channel || 'nightly' }}
              run: |
                  if [ "$CHANNEL" == "release" ]; then
                    FIREFOX_ID="{271903fe-1905-4636-b47f-6f0873dc97f8}"
                    echo "Using production Firefox extension ID"
                  else
                    FIREFOX_ID="dev@eurora-labs.com"
                    echo "Using development Firefox extension ID"
                  fi
                  printf "firefox_id=%s\n" "$FIREFOX_ID" >> "$GITHUB_OUTPUT"

            - name: Build Firefox extension
              run: pnpm run build:firefox
              env:
                  NODE_ENV: production
                  VERSION: ${{ env.version }}
                  FIREFOX_EXTENSION_ID: ${{ steps.firefox-id.outputs.firefox_id }}

            - name: Create Firefox extension zip
              shell: bash
              run: |
                  cd apps/browser/dist/firefox
                  zip -r ../../../../release/firefox-extension.zip . -x "*.git*" -x "*.zip"
                  cd ../../../..
                  echo "Created release/firefox-extension.zip"
                  ls -lh release/firefox-extension.zip

            - name: Upload Artifacts
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: '${{ env.channel }}-firefox-${{ github.run_number }}'
                  path: release/
                  if-no-files-found: error

    publish-firefox:
        needs: [build-firefox]
        runs-on: ubuntu-latest
        environment:
            name: firefox-addons
        permissions:
            contents: write # Required for creating and pushing git tags

        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Download artifacts
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: '${{ needs.build-firefox.outputs.channel }}-firefox-${{ github.run_number }}'
                  path: release

            - name: Extract version and extension
              shell: bash
              run: |
                  VERSION="$(cat release/version)"
                  echo "version=$VERSION" >> $GITHUB_ENV
                  # Extract the extension zip for signing
                  mkdir -p extension-source
                  unzip release/firefox-extension.zip -d extension-source

            - name: Install web-ext
              run: npm install -g web-ext@8.10.0

            - name: Sign and publish to Firefox Add-ons
              if: needs.build-firefox.outputs.channel == 'release'
              shell: bash
              env:
                  WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
                  WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
              run: |
                  cd extension-source

                  # Sign and submit the Firefox extension
                  web-ext sign \
                    --channel=listed \
                    --api-key="$WEB_EXT_API_KEY" \
                    --api-secret="$WEB_EXT_API_SECRET" \
                    --timeout=900000

                  echo "Extension signed and submitted to Firefox Add-ons store"

            - name: Sign for nightly channel
              if: needs.build-firefox.outputs.channel == 'nightly'
              shell: bash
              env:
                  WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
                  WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
              run: |
                  cd extension-source

                  # Sign and submit to unlisted (nightly) channel
                  web-ext sign \
                    --channel=unlisted \
                    --api-key="$WEB_EXT_API_KEY" \
                    --api-secret="$WEB_EXT_API_SECRET" \
                    --timeout=900000

                  echo "Extension signed for nightly channel"

            - name: Prepare S3 payload
              shell: bash
              run: |
                  rm -rf release-s3
                  mkdir -p release-s3
                  # Copy the signed XPI if it exists, otherwise use the zip
                  if ls extension-source/web-ext-artifacts/*.xpi 1> /dev/null 2>&1; then
                    cp extension-source/web-ext-artifacts/*.xpi release-s3/eurora.xpi
                  fi
                  cp release/firefox-extension.zip release-s3/

            - uses: shallwefootball/s3-upload-action@0d261a6f15b3b2e209dfebdecace4b100c04f95b # master
              name: Upload To S3
              id: S3
              with:
                  aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws_bucket: 'releases.eurora-labs.com'
                  source_dir: 'release-s3/'
                  destination_dir: 'extensions/${{ needs.build-firefox.outputs.channel }}/firefox/${{ env.version }}-${{ github.run_number }}'

    create-git-tag:
        needs: [publish-firefox, build-firefox]
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required for creating and pushing git tags
        steps:
            - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: true

            - name: Download artifacts
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
              with:
                  name: '${{ needs.build-firefox.outputs.channel }}-firefox-${{ github.run_number }}'
                  path: release

            - name: Extract version
              shell: bash
              run: |
                  VERSION="$(cat release/version)"
                  echo "version=$VERSION" >> $GITHUB_ENV

            - name: Create git tag
              shell: bash
              env:
                  OUTPUT_CHANNEL: ${{ needs.build-firefox.outputs.channel }}
                  VERSION: ${{ env.version }}
              run: |
                  TAG_NAME="firefox/${OUTPUT_CHANNEL}/${VERSION}"
                  function tag_exists() {
                    git tag --list | grep -q "^$1$"
                  }
                  function fetch_tag() {
                    git fetch origin "refs/tags/$1:refs/tags/$1"
                  }
                  function delete_tag() {
                    git push --delete origin "$1"
                  }
                  function create_tag() {
                    git tag --force "$1"
                    git push --tags
                  }

                  fetch_tag "$TAG_NAME" || true
                  if tag_exists "$TAG_NAME"; then
                    delete_tag "$TAG_NAME"
                  fi
                  create_tag "$TAG_NAME"
