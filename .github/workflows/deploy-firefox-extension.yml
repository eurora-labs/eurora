name: Deploy Firefox Extension

on:
    # Manual trigger
    workflow_dispatch:
        inputs:
            channel:
                type: choice
                required: true
                description: Release channel
                default: production
                options:
                    - production
                    - beta
            version:
                type: string
                required: true
                description: Extension version (e.g., 0.1.0)

    # Trigger on tags matching extension release pattern
    push:
        tags:
            - 'extension/v*.*.*'

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        environment:
            name: firefox-addons

        steps:
            - name: Checkout code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  persist-credentials: false
                  lfs: true

            - name: Init Node Environment
              uses: ./.github/actions/init-env-node

            - name: Install Protoc
              uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Compile Protobuf
              run: pnpm proto:typescript

            - name: Extract version from input or tag
              id: version
              shell: bash
              env:
                  EVENT_NAME: ${{ github.event_name }}
                  GITHUB_REF: ${{ github.ref }}
                  INPUT_VERSION: ${{ github.event.inputs.version }}
              run: |
                  if [ "$EVENT_NAME" == "push" ]; then
                    # Extract version from tag (e.g., extension/v0.1.0 -> 0.1.0)
                    VERSION="${GITHUB_REF#refs/tags/extension/v}"
                  else
                    VERSION="$INPUT_VERSION"
                  fi
                  if ! [[ "$VERSION" =~ ^[0-9]+(\.[0-9]+){2}([-\+][0-9A-Za-z\.-]+)?$ ]]; then
                    echo "Invalid version: $VERSION" >&2
                    exit 1
                  fi
                  printf "version=%s\n" "$VERSION" >> "$GITHUB_OUTPUT"
                  echo "Extension version: $VERSION"

            - name: Update manifest version
              shell: bash
              env:
                  VERSION: ${{ steps.version.outputs.version }}
              run: |
                  # Update version in Firefox manifest safely using jq
                  tmp=$(mktemp)
                  jq --arg v "$VERSION" '.version = $v' extensions/firefox/manifest.json > "$tmp"
                  mv "$tmp" extensions/firefox/manifest.json
                  echo "Updated manifest.json version to $VERSION"

            - name: Build everything for firefox
              run: pnpm build:firefox
              env:
                  NODE_ENV: production

            - name: Replace Firefox extension ID for production
              if: github.event.inputs.channel == 'production' || github.event_name == 'push'
              shell: bash
              run: |
                  # Replace dev ID with production ID in manifest
                  sed -i 's/"id": "dev@eurora-labs.com"/"id": "{271903fe-1905-4636-b47f-6f0873dc97f8}"/' extensions/firefox/manifest.json
                  echo "Replaced extension ID with production ID"

                  # Verify the change
                  grep '"id":' extensions/firefox/manifest.json

            - name: Create Firefox extension zip
              shell: bash
              run: |
                  cd extensions/firefox
                  zip -r ../../firefox-extension.zip . -x "*.git*" -x "*.zip"
                  cd ../..
                  echo "Created firefox-extension.zip"
                  ls -lh firefox-extension.zip

            - name: Upload artifact
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: firefox-extension-${{ steps.version.outputs.version }}
                  path: firefox-extension.zip
                  retention-days: 30

            - name: Install web-ext
              run: npm install -g web-ext@8.10.0

            - name: Sign and publish to Firefox Add-ons
              if: github.event.inputs.channel == 'production' || github.event_name == 'push'
              shell: bash
              env:
                  WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
                  WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
              run: |
                  cd extensions/firefox

                  # Sign and submit the extension
                  web-ext sign \
                    --channel=listed \
                    --api-key="$WEB_EXT_API_KEY" \
                    --api-secret="$WEB_EXT_API_SECRET" \
                    --timeout=900000

                  echo "Extension signed and submitted to Firefox Add-ons store"

            - name: Sign for beta channel
              if: github.event.inputs.channel == 'beta'
              shell: bash
              env:
                  WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
                  WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
              run: |
                  cd extensions/firefox

                  # Sign and submit to unlisted (beta) channel
                  web-ext sign \
                    --channel=unlisted \
                    --api-key="$WEB_EXT_API_KEY" \
                    --api-secret="$WEB_EXT_API_SECRET" \
                    --timeout=900000

                  echo "Extension signed for beta channel"

            - name: Create GitHub Release
              if: github.event_name == 'push'
              uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2
              with:
                  files: |
                      web-ext-artifacts/*.xpi
                      firefox-extension.zip
                  body: |
                      Firefox Extension Release ${{ steps.version.outputs.version }}

                      This release has been automatically built and submitted to the Firefox Add-ons store.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Notify on success
              if: success()
              run: |
                  echo "✅ Firefox extension ${{ steps.version.outputs.version }} successfully built and deployed!"

            - name: Notify on failure
              if: failure()
              run: |
                  echo "❌ Firefox extension deployment failed. Check the logs for details."
