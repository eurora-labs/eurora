services:
    postgres:
        image: postgres:16
        restart: unless-stopped
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: eurora
        ports:
            - '${EURORA_POSTGRES_PORT:-39432}:5432'
        volumes:
            - eurora-pgdata:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 5s
            timeout: 3s
            retries: 5

    backend:
        image: ghcr.io/eurora-labs/eurora/be-monolith:latest
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        ports:
            - '${EURORA_GRPC_PORT:-39051}:${EURORA_GRPC_PORT:-39051}'
            - '${EURORA_HTTP_PORT:-39080}:${EURORA_HTTP_PORT:-39080}'
        extra_hosts:
            - 'host.docker.internal:host-gateway'
        user: '${EURORA_UID:-1000}:${EURORA_GID:-1000}'
        environment:
            REMOTE_DATABASE_URL: postgresql://postgres:postgres@postgres:5432/eurora
            MONOLITH_ADDR: 0.0.0.0:${EURORA_GRPC_PORT:-39051}
            HTTP_ADDR: 0.0.0.0:${EURORA_HTTP_PORT:-39080}
            RUNNING_EURORA_FULLY_LOCAL: 'true'
            OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.2}
            OLLAMA_HOST: http://host.docker.internal:11434
            JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-access_secret}
            JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-refresh_secret}
            ASSET_STORAGE_BACKEND: fs
            ASSET_STORAGE_FS_ROOT: /data/assets
            APPROVED_EMAILS: '*'
        volumes:
            - ${EURORA_ASSET_DIR:-~/.local/share/eurora/assets}:/data/assets
            - ${EURORA_AUTHZ_DIR:-../../../config/authz}:/config/authz:ro

volumes:
    eurora-pgdata:
